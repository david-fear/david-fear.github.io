<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text Diff Tool</title>
  <script>
  (function () {
    const theme = localStorage.getItem("theme");
    if (theme === "dark") {
      document.documentElement.classList.add("dark-mode");
    }
  })();
  </script>

  <link rel="stylesheet" href="../stylesheet.css" />

  <style>
.diff-container {
  display: grid;
  grid-template-columns: 2fr auto 2fr;
  grid-template-rows: auto 1fr 2fr;
  gap: 20px;
  height: 90vh;
  padding: 20px;
  box-sizing: border-box;
}

textarea {
  width: 100%;
  height: 100%;
  font-family: monospace;
  font-size: 10px;
  white-space: pre;
  overflow: auto;
  resize: none;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 10px;
  box-sizing: border-box;
}

#ignoreBox {
  grid-column: 1 / 4;
}

#leftInput {
  grid-column: 1 / 2;
}

#rightInput {
  grid-column: 3 / 4;
}

.button-stack {
  grid-column: 2 / 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-self: center;
}

button {
  height: 46px;
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  border: none;
}

button:hover {
  opacity: 0.9;
}

/* ===========================
   OUTPUT CONTAINER
   =========================== */

#outputBox {
  grid-column: 1 / 4;
  border: 1px solid #ccc;
  background: #fafafa;
  padding: 10px;
  font-family: monospace;
  font-size: 10px;
  overflow-x: auto;
  overflow-y: auto;
  max-width: 100%;
  border-radius: 6px;
  box-sizing: border-box;
}

/* ===========================
   UNIFIED DIFF
   =========================== */

.diff-line {
  white-space: pre;
}

.diff-add {
  background: #e6ffec;
  color: #22863a;
}

.diff-del {
  background: #ffeef0;
  color: #b31d28;
}

.diff-same {
  color: #24292e;
}

/* Separator line for context gaps */
.context-separator {
  height: 1px;
  background: #ddd;
  margin: 4px 0;
}

/* ===========================
   SIDE BY SIDE DIFF
   =========================== */

.side-by-side {
  display: grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
  max-width: 100%;
}

.side-row {
  display: contents;
  min-width: 0;
}

.side-cell {
  white-space: pre;
  padding: 2px 6px;
  border-bottom: 1px solid #eee;
  max-width: 100%;
  overflow-x: auto;
  box-sizing: border-box;
}

.side-add {
  background: #e6ffec;
  color: #22863a;
}

.side-del {
  background: #ffeef0;
  color: #b31d28;
}

.side-empty {
  background: #fafafa;
}
  </style>
</head>

<body>

<!-- Menu will load here -->
<div id="menu-container"></div>

<script>
  fetch('../components/menu.html')
    .then(response => response.text())
    .then(data => {
      const container = document.getElementById('menu-container');
      container.innerHTML = data;

      // Now attach event listeners because the elements exist
      const toggle = document.getElementById('menu-toggle');
      const menu = document.getElementById('menu-nav');

      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!expanded));
        if (menu.hasAttribute('hidden')) {
          menu.removeAttribute('hidden');
        } else {
          menu.setAttribute('hidden', '');
        }
      });

      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle.click();
        }
      });
    })
    .catch(e => console.error('Failed to load menu:', e));
</script>

<header>
  <h1>DIFF</h1>
  <p></p>Paste two text blobs, define ignore rules if needed,
    then choose a diff mode.</p>
</header>

<div class="diff-container">

  <textarea id="ignoreBox" placeholder="IGNORE rules (one substring per line). Example:
  &quot;id&quot;:
  lastUpdated"></textarea>

  <textarea id="leftInput" placeholder="Left text (original)"></textarea>

  <div class="button-stack">
    <button id="diffBtn">DIFF</button>
    <button id="diffChangedBtn">DIFF (changes only)</button>
    <button id="sideBtn">SIDE BY SIDE</button>
    <button id="sideChangedBtn">SIDE BY SIDE (changes only)</button>
  </div>

  <textarea id="rightInput" placeholder="Right text (changed)"></textarea>

  <div id="outputBox">Diff output will appear here.</div>

</div>

<script>
const CONTEXT = 10;

function escapeHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function shouldIgnore(line, ignore) {
  return ignore.some(i => i && line.includes(i));
}

function getData() {
  return {
    left: document.getElementById("leftInput").value.split("\n"),
    right: document.getElementById("rightInput").value.split("\n"),
    ignore: document.getElementById("ignoreBox").value.split("\n").map(s => s.trim())
  };
}

function buildDiffMap(left, right, ignore) {
  const map = [];
  const max = Math.max(left.length, right.length);

  for (let i = 0; i < max; i++) {
    let l = left[i], r = right[i];
    if (l && shouldIgnore(l, ignore)) l = undefined;
    if (r && shouldIgnore(r, ignore)) r = undefined;

    map.push({
      l, r,
      same: l === r
    });
  }
  return map;
}

// Split diffMap into groups of consecutive lines, then add separator after every group
function insertContextSeparatorsAlways(diffMap) {
  if (diffMap.length === 0) return diffMap;

  const result = [];
  let group = [];

  function flushGroup() {
    if (group.length) {
      // Add group lines
      result.push(...group);
      // Add separator after group (except after last)
      result.push({separator: true});
      group = [];
    }
  }

  for (let i = 0; i < diffMap.length; i++) {
    if (i === 0) {
      group.push(diffMap[i]);
    } else {
      // If current line index is consecutive to previous in diffMap array (i.e. i == prev +1), add to current group
      if (i === (i - 1) + 1) {
        group.push(diffMap[i]);
      } else {
        // Different index - flush current group & start new
        flushGroup();
        group.push(diffMap[i]);
      }
    }
  }
  // Flush last group, but don't add separator after last group
  if (group.length) {
    result.push(...group);
  } else {
    // Remove last separator added (if any)
    if (result.length && result[result.length -1].separator) {
      result.pop();
    }
  }

  return result;
}

function withContextAlways(diffMap) {
  const keep = new Set();
  diffMap.forEach((row, i) => {
    if (!row.same) {
      for (let j = i - CONTEXT; j <= i + CONTEXT; j++) {
        if (j >= 0 && j < diffMap.length) keep.add(j);
      }
    }
  });
  const filtered = [...keep].sort((a,b)=>a-b).map(i => diffMap[i]);
  return insertContextSeparatorsAlways(filtered);
}

/* Unified */
function unified(diffMap, changesOnly) {
  const rows = changesOnly ? withContextAlways(diffMap) : diffMap;
  return rows.map(r => {
    if (r.separator) return `<div class="context-separator"></div>`;
    if (r.l === r.r) {
      return changesOnly ? null :
        `<div class="diff-line diff-same">  ${escapeHtml(r.l || "")}</div>`;
    }
    return [
      r.l !== undefined ? `<div class="diff-line diff-del">- ${escapeHtml(r.l)}</div>` : "",
      r.r !== undefined ? `<div class="diff-line diff-add">+ ${escapeHtml(r.r)}</div>` : ""
    ].join("");
  }).filter(Boolean).join("");
}

/* Side-by-side */
function sideBySide(diffMap, changesOnly) {
  const rows = changesOnly ? withContextAlways(diffMap) : diffMap;
  return `<div class="side-by-side">` + rows.map(r => {
    if (r.separator) {
      // full width separator row, blank cells spanning 2 columns
      return `
        <div class="side-row">
          <div class="side-cell side-empty" style="grid-column: span 2; height: 6px;"></div>
        </div>`;
    }
    if (r.l === r.r) {
      return `
        <div class="side-row">
          <div class="side-cell">${escapeHtml(r.l || "")}</div>
          <div class="side-cell">${escapeHtml(r.r || "")}</div>
        </div>`;
    }
    return `
      <div class="side-row">
        <div class="side-cell ${r.l!==undefined?"side-del":"side-empty"}">${escapeHtml(r.l||"")}</div>
        <div class="side-cell ${r.r!==undefined?"side-add":"side-empty"}">${escapeHtml(r.r||"")}</div>
      </div>`;
  }).join("") + `</div>`;
}

/* Buttons */
diffBtn.onclick = () => {
  const d = getData();
  outputBox.innerHTML = unified(buildDiffMap(d.left,d.right,d.ignore), false) || "No differences.";
};

diffChangedBtn.onclick = () => {
  const d = getData();
  outputBox.innerHTML = unified(buildDiffMap(d.left,d.right,d.ignore), true) || "No differences.";
};

sideBtn.onclick = () => {
  const d = getData();
  outputBox.innerHTML = sideBySide(buildDiffMap(d.left,d.right,d.ignore), false) || "No differences.";
};

sideChangedBtn.onclick = () => {
  const d = getData();
  outputBox.innerHTML = sideBySide(buildDiffMap(d.left,d.right,d.ignore), true) || "No differences.";
};
</script>

<script src="https://david-fear.github.io/components/darkmode.js"></script>

</body>
</html>