<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Text Diff Tool</title>

<link rel="stylesheet" href="../stylesheet.css" />

<style>
/* ===========================
   LAYOUT
   =========================== */

.diff-container {
  display: grid;
  grid-template-columns: 2fr auto 2fr;
  grid-template-rows: auto 1fr 2fr;
  gap: 20px;
  height: 90vh;
  padding: 20px;
  box-sizing: border-box;
}

textarea {
  width: 100%;
  height: 100%;
  font-family: monospace;
  font-size: 10px;
  white-space: pre;
  overflow: auto;
  resize: none;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 10px;
  box-sizing: border-box;
}

#ignoreBox { grid-column: 1 / 4; }
#leftInput { grid-column: 1 / 2; }
#rightInput { grid-column: 3 / 4; }

.button-stack {
  grid-column: 2 / 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-self: center;
}

button {
  height: 46px;
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  border: none;
}
button:hover { opacity: 0.9; }

/* ===========================
   OUTPUT + MARKERS
   =========================== */

#outputWrapper {
  grid-column: 1 / 4;
  position: relative;
  height: 100%;
}

#outputBox {
  height: 100%;
  border: 1px solid #ccc;
  background: #fafafa;
  padding: 10px;
  font-family: monospace;
  font-size: 10px;
  overflow: auto;
  max-width: 100%;
  border-radius: 6px;
  box-sizing: border-box;
}

/* Marker rail */
#scrollMarkers {
  position: absolute;
  top: 6px;
  right: 4px;
  width: 6px;
  height: calc(100% - 12px);
  pointer-events: auto;
}

.marker {
  position: absolute;
  left: 0;
  width: 100%;
  height: 3px;
  border-radius: 2px;
  cursor: pointer;
  opacity: 0.8;
}

.marker.add { background: #2da44e; }
.marker.del { background: #cf222e; }
.marker.both { background: #8250df; }

/* Tooltip */
.marker::after {
  content: attr(data-line);
  position: absolute;
  right: 10px;
  top: -4px;
  background: #222;
  color: #fff;
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
}

.marker:hover::after {
  opacity: 1;
}

/* ===========================
   UNIFIED DIFF
   =========================== */

.diff-line { white-space: pre; }
.diff-add { background:#e6ffec; color:#22863a; }
.diff-del { background:#ffeef0; color:#b31d28; }
.diff-same { color:#24292e; }

.context-separator {
  height: 1px;
  background: #ddd;
  margin: 4px 0;
}

/* ===========================
   SIDE BY SIDE
   =========================== */

.side-by-side {
  display: grid;
  grid-template-columns: minmax(0,1fr) minmax(0,1fr);
  max-width: 100%;
}

.side-row {
  display: contents;
  min-width: 0;
}

.side-cell {
  white-space: pre;
  padding: 2px 6px;
  border-bottom: 1px solid #eee;
  max-width: 100%;
  overflow-x: auto;
  box-sizing: border-box;
}

.side-add { background:#e6ffec; color:#22863a; }
.side-del { background:#ffeef0; color:#b31d28; }
.side-empty { background:#fafafa; }
</style>
</head>

<body>

<header>
  <h1>DIFF</h1>
  <p>Paste two text blobs, define ignore rules if needed, then choose a diff mode.</p>
</header>

<div class="diff-container">

<textarea id="ignoreBox" placeholder="IGNORE rules (one substring per line)
&quot;id&quot;
lastUpdated"></textarea>

<textarea id="leftInput" placeholder="Left text (original)"></textarea>

<div class="button-stack">
  <button id="diffBtn">DIFF</button>
  <button id="diffChangedBtn">DIFF (changes only)</button>
  <button id="sideBtn">SIDE BY SIDE</button>
  <button id="sideChangedBtn">SIDE BY SIDE (changes only)</button>
</div>

<textarea id="rightInput" placeholder="Right text (changed)"></textarea>

<div id="outputWrapper">
  <div id="outputBox">Diff output will appear here.</div>
  <div id="scrollMarkers"></div>
</div>

</div>

<script>
const CONTEXT = 3;
const MAX_MARKERS = 300;

function escapeHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function shouldIgnore(line, ignore) {
  return ignore.some(i => i && line.includes(i));
}

function getData() {
  return {
    left: leftInput.value.split("\n"),
    right: rightInput.value.split("\n"),
    ignore: ignoreBox.value.split("\n").map(s => s.trim())
  };
}

function buildDiffMap(left, right, ignore) {
  const map = [];
  const max = Math.max(left.length, right.length);
  for (let i = 0; i < max; i++) {
    let l = left[i], r = right[i];
    if (l && shouldIgnore(l, ignore)) l = undefined;
    if (r && shouldIgnore(r, ignore)) r = undefined;
    map.push({ l, r, same: l === r, index: i });
  }
  return map;
}

function unified(diffMap, changesOnly) {
  return diffMap.map(r => {
    if (r.l === r.r) {
      return changesOnly ? null :
        `<div class="diff-line diff-same" data-line="${r.index}">  ${escapeHtml(r.l||"")}</div>`;
    }
    return `
      ${r.l!==undefined?`<div class="diff-line diff-del" data-line="${r.index}">- ${escapeHtml(r.l)}</div>`:""}
      ${r.r!==undefined?`<div class="diff-line diff-add" data-line="${r.index}">+ ${escapeHtml(r.r)}</div>`:""}
    `;
  }).filter(Boolean).join("");
}

function sideBySide(diffMap, changesOnly) {
  return `<div class="side-by-side">` + diffMap.map(r => {
    if (r.l === r.r && changesOnly) return "";
    return `
      <div class="side-row" data-line="${r.index}">
        <div class="side-cell ${r.l!==undefined?"side-del":"side-empty"}">${escapeHtml(r.l||"")}</div>
        <div class="side-cell ${r.r!==undefined?"side-add":"side-empty"}">${escapeHtml(r.r||"")}</div>
      </div>`;
  }).join("") + `</div>`;
}

function renderMarkers(diffMap) {
  const rail = scrollMarkers;
  rail.innerHTML = "";

  const changes = diffMap.filter(r => !r.same);
  const step = Math.max(1, Math.ceil(changes.length / MAX_MARKERS));

  changes.forEach((r, i) => {
    if (i % step !== 0) return;
    const m = document.createElement("div");
    m.className = "marker " + (
      r.l!==undefined && r.r!==undefined ? "both" :
      r.l!==undefined ? "del" : "add"
    );
    m.style.top = `${(r.index / diffMap.length) * 100}%`;
    m.dataset.line = `Line ${r.index+1}`;
    m.onclick = () => scrollToLine(r.index);
    rail.appendChild(m);
  });
}

function scrollToLine(i) {
  const el = outputBox.querySelector(`[data-line="${i}"]`);
  if (el) outputBox.scrollTop = el.offsetTop - outputBox.clientHeight / 3;
}

function run(renderFn, changesOnly) {
  const d = getData();
  const map = buildDiffMap(d.left,d.right,d.ignore);
  outputBox.innerHTML = renderFn(map, changesOnly) || "No differences.";
  renderMarkers(map);
}

diffBtn.onclick = () => run(unified,false);
diffChangedBtn.onclick = () => run(unified,true);
sideBtn.onclick = () => run(sideBySide,false);
sideChangedBtn.onclick = () => run(sideBySide,true);
</script>

</body>
</html>