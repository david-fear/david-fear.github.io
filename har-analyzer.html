<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" href="https://david-fear.github.io/stylesheet.css" />
<title>HAR Analyzer</title>
<style>
  #dropzone { border: 2px dashed #999; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 20px; }
  #results {
    overflow-x: auto;
    max-width: 100%;
    border: 1px solid #ccc;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    table-layout: auto; /* allow flexible column widths */
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px;
    font-size: 10px;
    vertical-align: top
    word-break: break-all;
  }
  th {
    background: #f4f4f4;
  }
  #summary {
    margin-top: 20px;
    font-size: 14px;
  }
  pre {
    background: #f5f5f5;
    padding: 10px;
    overflow: auto;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  button {
    cursor: pointer;
    background-color: #007acc;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
  }
  button:hover {
    background-color: #005fa3;
  }
  tr.payload-row td {
    background-color: #fafafa;
    font-family: monospace;
  }
</style>
</head>
<body>
<!-- Dynamic sidebar menu START - right after BODY tag -->
<div id="menu-container"></div>
<script>
  fetch('menu.html')
    .then(response => response.text())
    .then(data => {
      const container = document.getElementById('menu-container');
      container.innerHTML = data;

      // Now attach event listeners because the elements exist
      const toggle = document.getElementById('menu-toggle');
      const menu = document.getElementById('menu-nav');

      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!expanded));
        if (menu.hasAttribute('hidden')) {
          menu.removeAttribute('hidden');
        } else {
          menu.setAttribute('hidden', '');
        }
      });

      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle.click();
        }
      });
    })
    .catch(e => console.error('Failed to load menu:', e));
</script>
<!-- Dynamic sidebar menu END -->

  <header>
    <h1>HAR Analyzer</h1>
  </header>

<main>
<div id="dropzone">Drop HAR file here or click to select</div>
<input type="file" id="fileInput" accept=".har" style="display:none;" />

<div id="summary"></div>
<div id="results"></div>
<pre id="rawJson"></pre>

<script>
let har = null;

const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const summaryDiv = document.getElementById("summary");
const resultsDiv = document.getElementById("results");
const rawJson = document.getElementById("rawJson");

dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.style.background = "#eee"; });
dropzone.addEventListener("dragleave", () => dropzone.style.background = "" );
dropzone.addEventListener("drop", e => {
    e.preventDefault();
    dropzone.style.background = "";
    if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

function handleFile(file) {
    const reader = new FileReader();
    reader.onload = evt => {
        try {
            const obj = JSON.parse(evt.target.result);
            har = obj; // store globally
            summarize(obj);
            renderTable(obj);
        } catch (e) {
            alert("Failed to parse HAR: " + e.message);
        }
    };
    reader.readAsText(file);
}

function summarize(obj) {
    if (!obj.log || !obj.log.entries) {
        summaryDiv.textContent = "Invalid HAR format";
        return;
    }

    const entries = obj.log.entries;
    const totalRequests = entries.length;
    const totalBytes = entries.reduce((sum, e) => sum + (e.response?.content?.size || 0), 0);
    const totalTime = entries.reduce((sum, e) => sum + (e.time || 0), 0);

    summaryDiv.innerHTML = `
        <strong>Total requests:</strong> ${totalRequests}<br>
        <strong>Total bytes:</strong> ${totalBytes.toLocaleString()}<br>
        <strong>Total time:</strong> ${totalTime.toFixed(2)} ms
    `;

    rawJson.textContent = JSON.stringify(
        {
            log: {
                version: har?.log?.version,
                creator: har?.log?.creator
            },
            summary: {
                totalRequests,
                totalBytes,
                totalTime
            }
        },
        null,
        2
    );
}

function renderTable(obj) {
    const entries = obj.log?.entries || [];
    
    let html = `
    <table>
        <tr>
            <th>Method</th>
            <th>URL</th>
            <th>Status</th>
            <th>Size</th>
            <th>Time (ms)</th>
            <th>Origin</th>
            <th>Content-Type</th>
            <th>Payload</th>
        </tr>
    `;

    entries.forEach((e, idx) => {
        const req = e.request;
        const res = e.response;

        // Extract Origin from request headers (case-insensitive)
        const originHeader = (req.headers || []).find(h => h.name.toLowerCase() === 'origin');
        const origin = originHeader ? originHeader.value : '';

        // Extract Content-Type from response headers (case-insensitive)
        const contentTypeHeader = (res.headers || []).find(h => h.name.toLowerCase() === 'content-type');
        const contentType = contentTypeHeader ? contentTypeHeader.value : '';

        const hasJSON = req?.postData?.text ? true : false;
        const hasParams = req?.postData?.params?.length > 0;

        // Prepare safe escaped JSON for display
        const payloadObj = {
            json: tryParseJson(req?.postData?.text) || req?.postData?.text || null,
            params: req?.postData?.params || null
        };
        const payloadDisplay = escapeHtml(JSON.stringify(payloadObj, null, 2));

        html += `
        <tr>
            <td>${escapeHtml(req?.method || '')}</td>
            <td>${escapeHtml(req?.url || '')}</td>
            <td>${res?.status || ''}</td>
            <td>${res?.content?.size || 0}</td>
            <td>${Math.round(e.time) || 0}</td>
            <td>${escapeHtml(origin)}</td>
            <td>${escapeHtml(contentType)}</td>
            <td>
                ${(hasJSON || hasParams)
                    ? `<button onclick="togglePayload(${idx})">View</button>`
                    : ""
                }
            </td>
        </tr>
        <tr id="payload-${idx}" class="payload-row" style="display:none;">
            <td colspan="8">
                <pre>${payloadDisplay}</pre>
            </td>
        </tr>
        `;
    });

    html += "</table>";
    resultsDiv.innerHTML = html;
}

function togglePayload(i) {
    const row = document.getElementById(`payload-${i}`);
    row.style.display = row.style.display === "none" ? "table-row" : "none";
}

function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, function(m) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[m];
    });
}

function tryParseJson(text) {
    if (!text) return null;
    try {
        return JSON.parse(text);
    } catch {
        return null;
    }
}
</script>

</body>
</html>
