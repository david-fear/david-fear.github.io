<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>HAR Analyzer</title>
<style>
 body { font-family: Arial, sans-serif; margin: 20px; }
 h1 { font-size: 24px; margin-bottom: 10px; }
 #dropzone { border: 2px dashed #999; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 20px; }
 table { width: 100%; border-collapse: collapse; margin-top: 20px; }
 th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }
 th { background: #f4f4f4; }
 #summary { margin-top: 20px; font-size: 14px; }
 pre { background: #f5f5f5; padding: 10px; overflow: auto; font-size: 12px; }
</style>
</head>
<body>
<!-- Dynamic sidebar menu START - right after BODY tag -->
<div id="menu-container"></div>
<script>
  fetch('menu.html')
    .then(response => response.text())
    .then(data => {
      const container = document.getElementById('menu-container');
      container.innerHTML = data;

      // Now attach event listeners because the elements exist
      const toggle = document.getElementById('menu-toggle');
      const menu = document.getElementById('menu-nav');

      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!expanded));
        if (menu.hasAttribute('hidden')) {
          menu.removeAttribute('hidden');
        } else {
          menu.setAttribute('hidden', '');
        }
      });

      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle.click();
        }
      });
    })
    .catch(e => console.error('Failed to load menu:', e));
</script>
<!-- Dynamic sidebar menu END -->
<h1>HAR Analyzer</h1>
<div id="dropzone">Drop HAR file here or click to select</div>
<input type="file" id="fileInput" accept=".har" style="display:none;" />

<div id="summary"></div>
<div id="results"></div>
<pre id="rawJson"></pre>

<script>
let har = null;

const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const summaryDiv = document.getElementById("summary");
const resultsDiv = document.getElementById("results");
const rawJson = document.getElementById("rawJson");

dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.style.background = "#eee"; });
dropzone.addEventListener("dragleave", () => dropzone.style.background = "" );
dropzone.addEventListener("drop", e => {
    e.preventDefault();
    dropzone.style.background = "";
    if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

function handleFile(file) {
    const reader = new FileReader();
    reader.onload = evt => {
        try {
            const obj = JSON.parse(evt.target.result);
            har = obj; // FIX: store globally
            summarize(obj);
            renderTable(obj);
        } catch (e) {
            alert("Failed to parse HAR: " + e.message);
        }
    };
    reader.readAsText(file);
}

function summarize(obj) {
    if (!obj.log || !obj.log.entries) {
        summaryDiv.textContent = "Invalid HAR format";
        return;
    }

    const entries = obj.log.entries;
    const totalRequests = entries.length;
    const totalBytes = entries.reduce((sum, e) => sum + (e.response?.content?.size || 0), 0);
    const totalTime = entries.reduce((sum, e) => sum + (e.time || 0), 0);

    summaryDiv.innerHTML = `
        <strong>Total requests:</strong> ${totalRequests}<br>
        <strong>Total bytes:</strong> ${totalBytes.toLocaleString()}<br>
        <strong>Total time:</strong> ${totalTime.toFixed(2)} ms
    `;

    rawJson.textContent = JSON.stringify(
        {
            log: {
                version: har?.log?.version,
                creator: har?.log?.creator
            },
            summary: {
                totalRequests,
                totalBytes,
                totalTime
            }
        },
        null,
        2
    );
}

function renderTable(obj) {
    const entries = obj.log?.entries || [];
    let html = "<table><tr><th>Method</th><th>URL</th><th>Status</th><th>Size</th><th>Time (ms)</th></tr>";

    for (const e of entries) {
        const req = e.request;
        const res = e.response;
        html += `<tr>
            <td>${req?.method || ''}</td>
            <td>${req?.url || ''}</td>
            <td>${res?.status || ''}</td>
            <td>${res?.content?.size || 0}</td>
            <td>${e.time || 0}</td>
        </tr>`;
    }

    html += "</table>";
    resultsDiv.innerHTML = html;
}
</script>
</body>
</html>
